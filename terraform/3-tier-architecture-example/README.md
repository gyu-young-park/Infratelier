# 3-tier-architecture

```
CLIENT ---> WEB server ---> WAS ---> DB
        [nginx, haproxy]   [Java]
```
이렇게 나누는 것이 바로 3-tier architecture라고 한다. 이 3-tier architecture는 다음과 같이 정리 할 수 있다.

1. Public: 외부와 통신하며, 공격이 성공하더라도 내부로 직접 들어오지는 못하게 한다. 사용자의 요청을 처리하는 웹서버, 리버스 프록시가 존재하는 서브넷이다.
2. Private: Application이 있는 곳으로 외부와 직접적인 접점은 없으면 Public과 DB subnet과 통신한다. 
3. DB: Private subnet에 있는 App만 접근 가능하고 데이터를 저장하는 서비스가 존재하는 서브넷이다.

DB subnet까지는 만들지 않을 것이다. 실제로는 DB subnet의 ACL을 따로 설정해놓기는 한다.

VPC 설계 시 고려사항은 다음과 같다.
1. 16 bit cidr 블록
2. 다른 클라우드, on-premise과의 관계
3. 사용자 대역 172, 서버 대역 10
4. 하위 서브넷 또는 특정 대역의 IP들을 하나로 묶을 수 있도록 고려
    1. 10.220.0.0/16 (dev/test vpc로 사용) + 10.221.0.0/16 (prod vpc) => 10.220.0.0/15 (all vpc)
    2. 10.200.0.0/16 ~ 10.207.0.0/16 = 10.200.0.0/13 (Azure 대역)
    3. 이렇게 각 용도에 따른 대역을 나누는 것이다. 나누면 방화벽 또는 라우팅 테이블 작업 시 효율이 상승한다.
    4. IP 대역에 대한 가시성이 향상한다.

VPC를 직접 설계해보자.
1. 전체 서버 대역: 10.0.0.0/8
2. 클라우드 사용 대역: 10.64.0.0/10 => 10.64.0.0 ~ 10.127.255.255
3. AWS 사용 대역: 10.64.0.0/12 => 10.64.0.0 ~ 10.79.255.255
4. AWS 계정: Security, Control, Dev, Test, Pod
5. Dev 사용 대역: 10.64.0.0/16 (AZ 2개)
    a. public - 10.64.0.0/23 => 10.64.0.0/24, 10.64.1.0/24
    b. private - 10.64.128.0/19 => 10.64.128.0/20, 10.64.144.0/20
    c. db - 10.64.192.0/22 => 10.64.192.0/23, 10.64.194.0/23
    d. firewall - 10.64.255.0/27 -> 10.64.255.0/28, 10.64.255.16/28

cidr로 28이 최대이다.

AWS network firewall은 방화벽을 거치는 순간, 즉 middlebox appliance를 거치는 순간 Security Group Reference 기능이 동작하지 않는다. 